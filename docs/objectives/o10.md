---
icon: material/ssh
---

# The Open Door

**Difficulty**: :fontawesome-solid-snowflake:{ .red }:fontawesome-regular-snowflake::fontawesome-regular-snowflake::fontawesome-regular-snowflake::fontawesome-regular-snowflake:<br/>
![lucas](../img/objectives/o10/lucas.png)

## Objective

!!! question "Request"
    Help Goose Lucas in the hotel parking lot find the dangerously misconfigured Network Security Group rule that's allowing unrestricted internet access to sensitive ports like RDP or SSH.

??? quote "Goose Lucas"
    Please make sure the towns Azure network is secured properly.

    The Neighborhood HOA uses Azure for their IT infrastructure.

    Audit their network security configuration to ensure production systems aren't exposed to internet attacks.

    They claim all systems are properly protected, but you need to verify there are no overly permissive NSG rules.

## Hints

??? tip "The Open Door"
    This terminal has built-in hints!

## Solution

Like the other geese, Lucas has another Azure challenge that starts in the terminal. In this terminal, we start by exploring output formats. The default is JSON and we use the command `az group list` to see an example. 

```json title="Default JSON"
[
  {
    "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/theneighborhood-rg1",
    "location": "eastus",
    "managedBy": null,
    "name": "theneighborhood-rg1",
    "properties": {
      "provisioningState": "Succeeded"
    },
    "tags": {}
  },
  {
    "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/theneighborhood-rg2",
    "location": "westus",
    "managedBy": null,
    "name": "theneighborhood-rg2",
    "properties": {
      "provisioningState": "Succeeded"
    },
    "tags": {}
  }
]
```

Next, we use a command that we might recognize from some of the other challenges, or from reading the documentation before getting to this terminal, `az group list -o table`

```json title="Table Output"
Name                 Location    ProvisioningState
-------------------  ----------  -------------------
theneighborhood-rg1  eastus      Succeeded
theneighborhood-rg2  westus      Succeeded
```

### Network Security Groups (NSGs)

After the introductory commands, we start getting into the focus of this challenge and are introduced to Network Security Groups (NSGs) with [documentation](https://learn.microsoft.com/en-us/cli/azure/network/nsg?view=azure-cli-latest) and the command `az network nsg list -o table`.

```json title="NSG List"
Location    Name                   ResourceGroup
----------  ---------------------  -------------------
eastus      nsg-web-eastus         theneighborhood-rg1
eastus      nsg-db-eastus          theneighborhood-rg1
eastus      nsg-dev-eastus         theneighborhood-rg2
eastus      nsg-mgmt-eastus        theneighborhood-rg2
eastus      nsg-production-eastus  theneighborhood-rg1
```

We need to inspect the NSG (web) next. The hint tells us to use the `show` command. Using the NSG name and resource group from the previous command we can build out the following: `az network nsg show --name nsg-web-eastus --resource-group theneighborhood-rg1 -o table`.

!!! success
    ```json title="NSG (web)"
    Name            ResourceGroup        Location    Tags     ProvisioningState
    --------------  -------------------  ----------  -------  -------------------
    nsg-web-eastus  theneighborhood-rg1  eastus      env=web  Succeeded
    ```

Next, we need to inspect the NSG (mgmt) but this the hint wants us to `list` the NSG rules and gives us [docs](https://learn.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az-network-nsg-rule-list) to read over. We can build out the command in the same way, `az network nsg rule list --name nsg-mgmt-eastus --resource-group theneighborhood-rg2 -o table`.

```json title="mgmt NSG Rules"
Access    Direction    Name                        Priority    Protocol    NSG              SourceAddressPrefix    SourcePortRange    DestinationAddressPrefix    DestinationPortRange
--------  -----------  --------------------------  ----------  ----------  ---------------  ---------------------  -----------------  --------------------------  ----------------------
Allow     Inbound      Allow-AzureBastion          100         Tcp         nsg-mgmt-eastus  AzureBastion           *                  *                           443
Allow     Inbound      Allow-Monitoring-Inbound    110         Tcp         nsg-mgmt-eastus  AzureMonitor           *                  *                           443
Allow     Inbound      Allow-DNS-From-VNet         115         Udp         nsg-mgmt-eastus  VirtualNetwork         *                  *                           53
Deny      Inbound      Deny-All-Inbound            4096        *           nsg-mgmt-eastus  *                      *                  *                           *
Allow     Outbound     Allow-Monitoring-Outbound   200         Tcp         nsg-mgmt-eastus  *                      *                  AzureMonitor                443
Allow     Outbound     Allow-AD-Identity-Outbound  210         Tcp         nsg-mgmt-eastus  *                      *                  AzureActiveDirectory        443
Allow     Outbound     Allow-Backup-Outbound       220         Tcp         nsg-mgmt-eastus  *                      *                  AzureBackup                 443
```

Now we have to start figuring more things on our own. The prompt wants us to enumerate the rest of the NSG rules and find the suspect rule to view.<br/>
Our hint this time says "Review fields such as direction, access, protocol, source, destination and port settings." and provides some more [documentation](https://learn.microsoft.com/en-us/cli/azure/network/nsg/rule?view=azure-cli-latest#az-network-nsg-rule-show). I just worked my way down the NSG list from earlier, starting with (web). Since the command is already built, use the ++"UP"++ arrow on your keyboard to show the last command entered, then edit it to show each of the NSG rules.

#### Web

`az network nsg rule list --name nsg-web-eastus --resource-group theneighborhood-rg1 -o table`

```json title="NSG web rules"
Access    Direction    Name                           Priority    Protocol    NSG             SourceAddressPrefix    SourcePortRange    DestinationAddressPrefix    DestinationPortRange
--------  -----------  -----------------------------  ----------  ----------  --------------  ---------------------  -----------------  --------------------------  ----------------------
Allow     Inbound      Allow-HTTP-Inbound             100         Tcp         nsg-web-eastus  0.0.0.0/0              *                  *                           80
Allow     Inbound      Allow-HTTPS-Inbound            110         Tcp         nsg-web-eastus  0.0.0.0/0              *                  *                           443
Allow     Inbound      Allow-AppGateway-HealthProbes  130         Tcp         nsg-web-eastus  AzureLoadBalancer      *                  *                           80,443
Allow     Inbound      Allow-Web-To-App               200         Tcp         nsg-web-eastus  VirtualNetwork         *                  *                           8080,8443
Deny      Inbound      Deny-All-Inbound               4096        *           nsg-web-eastus  *                      *                  *                           *
```

#### DB

`az network nsg rule list --name nsg-db-eastus --resource-group theneighborhood-rg1 -o table`

```json title="NSG db rules"
Access    Direction    Name                     Priority    Protocol    NSG            SourceAddressPrefix    SourcePortRange    DestinationAddressPrefix    DestinationPortRange
--------  -----------  -----------------------  ----------  ----------  -------------  ---------------------  -----------------  --------------------------  ------------------------
Allow     Inbound      Allow-App-To-DB          100         Tcp         nsg-db-eastus  VirtualNetwork         *                  *                           1433
Allow     Inbound      Allow-AD-Trusted-Subnet  110         Tcp         nsg-db-eastus  10.1.0.0/24            *                  *                           88,389,636,3268-3269,445
Deny      Inbound      Deny-All-Inbound         4096        *           nsg-db-eastus  *                      *                  *                           *
```

#### Dev

`az network nsg rule list --name nsg-dev-eastus --resource-group theneighborhood-rg2 -o table
`

```json title="NSG dev rules"
Access    Direction    Name                         Priority    Protocol    NSG             SourceAddressPrefix    SourcePortRange    DestinationAddressPrefix    DestinationPortRange
--------  -----------  ---------------------------  ----------  ----------  --------------  ---------------------  -----------------  --------------------------  ----------------------
Allow     Inbound      Allow-HTTP-Inbound           100         Tcp         nsg-dev-eastus  0.0.0.0/0              *                  *                           80
Allow     Inbound      Allow-HTTPS-Inbound          110         Tcp         nsg-dev-eastus  0.0.0.0/0              *                  *                           443
Allow     Inbound      Allow-DevOps-Agents          115         Tcp         nsg-dev-eastus  AzureDevOps            *                  *                           5986
Allow     Inbound      Allow-Jumpbox-Remote-Access  120         Tcp         nsg-dev-eastus  10.2.0.0/24            *                  *                           3389,22
Deny      Inbound      Deny-All-Inbound             4096        *           nsg-dev-eastus  *                      *                  *                           *
```

#### Production

`az network nsg rule list --name nsg-production-eastus --resource-group theneighborhood-rg1 -o table`

```json title="NSG production rules" hl_lines="6"
Access    Direction    Name                           Priority    Protocol    NSG                    SourceAddressPrefix    SourcePortRange    DestinationAddressPrefix    DestinationPortRange
--------  -----------  -----------------------------  ----------  ----------  ---------------------  ---------------------  -----------------  --------------------------  ----------------------
Allow     Inbound      Allow-HTTP-Inbound             100         Tcp         nsg-production-eastus  0.0.0.0/0              *                  *                           80
Allow     Inbound      Allow-HTTPS-Inbound            110         Tcp         nsg-production-eastus  0.0.0.0/0              *                  *                           443
Allow     Inbound      Allow-AppGateway-HealthProbes  115         Tcp         nsg-production-eastus  AzureLoadBalancer      *                  *                           80,443
Allow     Inbound      Allow-RDP-From-Internet        120         Tcp         nsg-production-eastus  0.0.0.0/0              *                  *                           3389
Deny      Inbound      Deny-All-Inbound               4096        *           nsg-production-eastus  *                      *                  *                           *
```

That doesn't look right. Lets check it out. 

!!! success
    `az network nsg rule show --resource-group theneighborhood-rg1 --nsg-name nsg-production-eastus --name Allow-RDP-From-Internet -o table`

    ```json title="RDP Misconfigure"
    Name                     Priority    Access    Direction    Protocol    SourceAddressPrefix    SourcePortRange    DestinationAddressPrefix    DestinationPortRange    ProvisioningState
    -----------------------  ----------  --------  -----------  ----------  ---------------------  -----------------  --------------------------  ----------------------  -------------------
    Allow-RDP-From-Internet  120         Allow     Inbound      Tcp         0.0.0.0/0                                                             3389                    Succeeded
    ```

!!! success "RDP Misconfiguration"
    ![success](../img/objectives/o10/success.png)

## Response

!!! quote "Lucas"
    Ha! 'Properly protected' they said. More like 'properly exposed to the entire internet'! Good catch, amigo.
