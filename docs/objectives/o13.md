---
icon: material/email-alert-outline
---

# Mail Detective

**Difficulty**: :fontawesome-solid-snowflake:{ .red }:fontawesome-solid-snowflake:{ .red }:fontawesome-regular-snowflake::fontawesome-regular-snowflake::fontawesome-regular-snowflake:<br/>
**Direct link**: [Objective6.zip](https://.../)

## Objective

!!! question "Request"
    Help Mo in City Hall solve a curly email caper and crack the IMAP case. What is the URL of the pastebin service the gnomes are using?

??? quote "Mo"
    So here's our situation: those gnomes have been sending JavaScript-enabled emails to everyone in the neighborhood, and it's causing chaos.

    We had to shut down all the email clients because they weren't blocking the malicious scripts - kind of like how we'd ground aircraft until we clear a security threat.

    The only safe way to access the email server now is through curl - yes, the HTTP tool!

    Think you can help me use curl to connect to the IMAP server and hunt down one of these gnome emails?

## Hints

??? tip "Did You Say Curl?"
    If I heard this correctly...our sneaky security gurus found a way to interact with the IMAP server using Curl! Yes...the CLI HTTP tool! Here are some helpful docs I found https://everything.curl.dev/usingcurl/reademail.html

## Solution

We're back to the terminal with this challenge:

![terminal](../img/objectives/o13/mail_intro.png)

It repeats what we get from Mo, and then builds on it with our mission and some server info. 

### Mission

!!! question "YOUR MISSION" 
    Use curl to safely connect to the IMAP server and hunt down one of these gnome emails. Find the malicious email that wants to exfiltrate data to a pastebin service and submit the URL of that pastebin service in your badge.

!!! info "Server Info"
    The IMAP server is running locally on TCP port 143<br/>
    Backdoor credentials: `dosismail:holidaymagic`<br/>

### Terminal

If you are like me, then the first thing to do is follow the [link](https://everything.curl.dev/usingcurl/reademail.html) and read up on using `curl` to interact with IMAP.<br/>
Seems pretty straightforward so lets start making use of it and begin the enumeration of the server. We are looking for a pastebin service that is being used for exfiltration, so another forensics focused challenge.<br/>

#### Mailboxes - Enumeration

It took some experimentation, but eventually I was able to list the available mailboxes:

```bash title="List Mailboxes"
curl -v imap://dosismail:holidaymagic@localhost:143 -X 'LIST "" "*"'
*   Trying 127.0.0.1:143...
* Connected to localhost (127.0.0.1) port 143 (#0)
< * OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ STARTTLS AUTH=PLAIN AUTH=LOGIN] Dovecot (Ubuntu) ready.
> A001 CAPABILITY
< * CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ STARTTLS AUTH=PLAIN AUTH=LOGIN
< A001 OK Pre-login capabilities listed, post-login capabilities have more.
> A002 AUTHENTICATE PLAIN AGRvc2lzbWFpbABob2xpZGF5bWFnaWM=
< * CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE SORT SORT=DISPLAY THREAD=REFERENCES THREAD=REFS THREAD=ORDEREDSUBJECT MULTIAPPEND URL-PARTIAL CATENATE UNSELECT CHILDREN NAMESPACE UIDPLUS LIST-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=SEARCH LIST-STATUS BINARY MOVE SNIPPET=FUZZY PREVIEW=FUZZY PREVIEW STATUS=SIZE SAVEDATE LITERAL+ NOTIFY
< A002 OK Logged in
> A003 LIST "" "*"
< * LIST (\HasNoChildren) "." Spam
* LIST (\HasNoChildren) "." Spam
< * LIST (\HasNoChildren) "." Sent
* LIST (\HasNoChildren) "." Sent
< * LIST (\HasNoChildren) "." Archives
* LIST (\HasNoChildren) "." Archives
< * LIST (\HasNoChildren) "." Drafts
* LIST (\HasNoChildren) "." Drafts
< * LIST (\HasNoChildren) "." INBOX
* LIST (\HasNoChildren) "." INBOX
< A003 OK List completed (0.001 + 0.000 secs).
* Connection #0 to host localhost left intact
```

Great! We can see our list of targets now.
 * Spam
 * Sent
 * Archives
 * Drafts
 * INBOX

We can use the `STATUS` command to get information about the diffent mailboxes:

```bash title="Enumeration - INBOX"
curl -v imap://dosismail:holidaymagic@localhost:143 -X 'STATUS INBOX (MESSAGES)'
```

```bash title="Results - INBOX"
> A003 STATUS INBOX (MESSAGES)
< * STATUS INBOX (MESSAGES 7)
* STATUS INBOX (MESSAGES 7)
< A003 OK Status completed (0.007 + 0.000 + 0.006 secs).
* Connection #0 to host localhost left intact
```

```bash title="Enumeration - Spam"
curl -v imap://dosismail:holidaymagic@localhost:143 -X 'STATUS Spam (MESSAGES)'
```

```bash title="Results - Spam"
< A002 OK Logged in
> A003 STATUS Spam (MESSAGES)
< * STATUS Spam (MESSAGES 3)
* STATUS Spam (MESSAGES 3)
< A003 OK Status completed (0.004 + 0.000 + 0.003 secs).
* Connection #0 to host localhost left intact
```

```bash title="Enumeration - Archives"
curl -v imap://dosismail:holidaymagic@localhost:143 -X 'STATUS Archives (MESSAGES)'
```

```bash title="Enumeration - Archives"
< A002 OK Logged in
> A003 STATUS Archives (MESSAGES)
< * STATUS Archives (MESSAGES 7)
* STATUS Archives (MESSAGES 7)
< A003 OK Status completed (0.004 + 0.000 + 0.003 secs).
* Connection #0 to host localhost left intact
```

```bash title="Enumeration - Sent"
curl -v imap://dosismail:holidaymagic@localhost:143 -X 'STATUS Sent (MESSAGES)'
```

```bash title="Enumeration - Sent"
< A002 OK Logged in
> A003 STATUS Sent (MESSAGES)
< * STATUS Sent (MESSAGES 0)
* STATUS Sent (MESSAGES 0)
< A003 OK Status completed (0.005 + 0.000 + 0.004 secs).
* Connection #0 to host localhost left intact
```

```bash title="Enumeration - Drafts"
curl -v imap://dosismail:holidaymagic@localhost:143 -X 'STATUS Drafts (MESSAGES)'
```

```bash title="Enumeration - Drafts"
< A002 OK Logged in
> A003 STATUS Drafts (MESSAGES)
< * STATUS Drafts (MESSAGES 2)
* STATUS Drafts (MESSAGES 2)
< A003 OK Status completed (0.004 + 0.000 + 0.003 secs).
* Connection #0 to host localhost left intact
```

#### Mailbox Investigations

There are 5 mailboxes with only the *Sent* box being empty. There are 2 drafts, 3 Spam, and 7 each in the INBOX and Archive. I'm going to assume the INBOX and Archive are the same for the time being. Since we have to start somewhere, lets start with the box with the least amount:

```bash title="Investigation"
curl -v --user dosismail:holidaymagic "imap://localhost:143/Drafts;UID=1:*"
```

This command lists the emails in the mailbox and shows two seperate emails were being drafted, one for tech support and one for security, both reporting the email breach and other security concerns. When we run the same command for `INBOX`, we get further clues and insights about the suspicious activities in the besieged town but it isn't until we check the Spam folder that we start making progress on finding one of the malicious emails. 

!!! success "Spam"
    We saw earlier how the Spam mailbox contained three emails. When we run `curl -v --user dosismail:holidaymagic "imap://localhost:143/Spam;UID=1:*"` and review the emails, they are quite obviously malicious scripts! We knew there were malicious scripts though, that's why the email is shutdown. What we need is a specific pastebin link. Reading through the various scripts, we find a block of code conveiniently labeled exfiltration!

    ![exfil](../img/objectives/o13/exfil.png)

## Response

!!! quote "Mo"
    Outstanding work! You've mastered using curl for IMAP - that's some serious command-line skills that would make any Air Force tech proud.

    Counter Hack really is the best job I have ever had, especially when we get to solve problems like this!
